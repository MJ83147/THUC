<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tournament Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0f1115;
      --surface: #1a1d24;
      --surface-2: #22262e;
      --border: #2e333d;
      --border-light: #3a404d;
      --text: #e2e4e9;
      --text-muted: #8b8f99;
      --accent: #e8a832;
      --accent-dim: #c48a1a;
      --red: #d94848;
      --red-dim: #b33a3a;
      --green: #3dba6a;
      --green-dim: #2d9452;
      --font-mono: 'JetBrains Mono', monospace;
      --font-body: 'DM Sans', sans-serif;
    }

    body {
      font-family: var(--font-body);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
    }

    /* --- HEADER --- */
    .header {
      padding: 24px 32px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-family: var(--font-mono);
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.5px;
      color: var(--accent);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-badge {
      font-family: var(--font-mono);
      font-size: 12px;
      font-weight: 600;
      padding: 5px 12px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-setup { background: var(--surface-2); color: var(--text-muted); border: 1px solid var(--border); }
    .status-active { background: rgba(61, 186, 106, 0.12); color: var(--green); border: 1px solid var(--green-dim); }
    .status-complete { background: rgba(232, 168, 50, 0.12); color: var(--accent); border: 1px solid var(--accent-dim); }

    /* --- LAYOUT --- */
    .main {
      display: grid;
      grid-template-columns: 380px 1fr;
      min-height: calc(100vh - 73px);
    }

    /* --- SIDEBAR: PLAYERS --- */
    .sidebar {
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 20px 24px 16px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-header h2 {
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .add-player-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .add-player-form input {
      font-family: var(--font-mono);
      font-size: 13px;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 4px;
      width: 100%;
    }

    .add-player-form input:focus { outline: none; border-color: var(--accent); }
    .add-player-form input::placeholder { color: var(--border-light); }

    .add-player-row {
      display: flex;
      gap: 8px;
    }

    .add-player-row input:first-child { flex: 1.4; }
    .add-player-row input:last-child { flex: 1; }

    .form-buttons {
      display: flex;
      gap: 8px;
    }

    .btn-add {
      font-family: var(--font-body);
      font-size: 13px;
      font-weight: 600;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid var(--accent-dim);
      background: rgba(232, 168, 50, 0.1);
      color: var(--accent);
      cursor: pointer;
      transition: background 0.15s;
      flex: 1;
    }

    .btn-add:hover { background: rgba(232, 168, 50, 0.2); }

    .btn-sample {
      font-family: var(--font-body);
      font-size: 13px;
      font-weight: 600;
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: none;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }

    .btn-sample:hover { border-color: var(--text-muted); color: var(--text); }

    /* --- BYE INFO --- */
    .bye-info {
      padding: 10px 24px;
      border-bottom: 1px solid var(--border);
      font-family: var(--font-mono);
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .bye-info.hidden { display: none; }

    .bye-needed { color: var(--text-muted); }
    .bye-count { font-weight: 600; }
    .bye-count.ok { color: var(--green); }
    .bye-count.mismatch { color: var(--red); }

    /* --- PLAYER LIST --- */
    .player-list {
      flex: 1;
      overflow-y: auto;
      padding: 4px 0;
    }

    .player-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 24px;
      transition: background 0.1s;
    }

    .player-item:hover { background: var(--surface); }

    .bye-toggle {
      appearance: none;
      width: 18px;
      height: 18px;
      border: 2px solid var(--border-light);
      border-radius: 3px;
      background: var(--bg);
      cursor: pointer;
      flex-shrink: 0;
      position: relative;
      transition: all 0.15s;
    }

    .bye-toggle:checked {
      background: var(--accent);
      border-color: var(--accent);
    }

    .bye-toggle:checked::after {
      content: '';
      position: absolute;
      top: 1px;
      left: 5px;
      width: 4px;
      height: 9px;
      border: solid var(--bg);
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }

    .player-info {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-width: 0;
    }

    .player-name {
      font-size: 14px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .player-meta {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .player-torn-id {
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--text-muted);
    }

    .player-torn-id a {
      color: var(--text-muted);
      text-decoration: none;
    }

    .player-torn-id a:hover { color: var(--accent); }

    .player-bye-label {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--accent);
      background: rgba(232, 168, 50, 0.12);
      padding: 1px 6px;
      border-radius: 3px;
    }

    .btn-remove {
      font-family: var(--font-mono);
      font-size: 11px;
      background: none;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 3px 8px;
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.15s;
      flex-shrink: 0;
    }

    .btn-remove:hover { border-color: var(--red); color: var(--red); }

    .player-count {
      padding: 12px 24px;
      border-top: 1px solid var(--border);
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--text-muted);
    }

    /* --- MAIN PANEL: MATCHES --- */
    .panel {
      display: flex;
      flex-direction: column;
    }

    .panel-toolbar {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .panel-toolbar h2 {
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    .toolbar-actions { display: flex; gap: 8px; }

    .btn {
      font-family: var(--font-body);
      font-size: 13px;
      font-weight: 600;
      padding: 8px 16px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .btn:hover { opacity: 0.85; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .btn-primary { background: var(--accent); color: var(--bg); }
    .btn-danger { background: var(--red); color: #fff; }
    .btn-outline { background: none; border: 1px solid var(--border); color: var(--text-muted); }
    .btn-outline:hover { border-color: var(--text-muted); color: var(--text); }

    /* --- MATCH LIST --- */
    .match-sections {
      flex: 1;
      overflow-y: auto;
      padding: 16px 24px 32px;
    }

    .section-title {
      font-family: var(--font-mono);
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--accent);
      margin: 24px 0 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    .section-title:first-child { margin-top: 0; }

    .match-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-bottom: 8px;
      overflow: hidden;
    }

    .match-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      background: var(--surface-2);
      border-bottom: 1px solid var(--border);
    }

    .match-id {
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
    }

    .match-status {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 2px 8px;
      border-radius: 3px;
    }

    .match-status-pending { background: var(--surface); color: var(--text-muted); }
    .match-status-ready { background: rgba(61, 186, 106, 0.15); color: var(--green); }
    .match-status-complete { background: rgba(232, 168, 50, 0.12); color: var(--accent); }
    .match-status-bye { background: var(--surface); color: var(--border-light); }

    .match-body {
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .match-player {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: var(--bg);
      border-radius: 4px;
      border: 1px solid var(--border);
      min-height: 42px;
    }

    .match-player.winner-highlight {
      border-color: var(--green-dim);
      background: rgba(61, 186, 106, 0.06);
    }

    .match-player.loser-highlight {
      border-color: var(--red-dim);
      opacity: 0.5;
    }

    .match-player-name { font-size: 14px; font-weight: 600; }
    .match-player-name.bye { color: var(--border-light); font-style: italic; }
    .match-player-name.tbd { color: var(--text-muted); font-style: italic; }

    .match-vs {
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 700;
      color: var(--border-light);
    }

    .btn-win {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      padding: 4px 10px;
      border-radius: 3px;
      border: 1px solid var(--green-dim);
      background: rgba(61, 186, 106, 0.1);
      color: var(--green);
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn-win:hover { background: rgba(61, 186, 106, 0.25); }

    /* --- CHAMPION BANNER --- */
    .champion-banner {
      padding: 24px;
      text-align: center;
      background: rgba(232, 168, 50, 0.08);
      border: 1px solid var(--accent-dim);
      border-radius: 6px;
      margin-bottom: 24px;
    }

    .champion-banner h3 {
      font-family: var(--font-mono);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .champion-name { font-size: 28px; font-weight: 700; color: var(--accent); }

    /* --- TOAST --- */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .toast {
      font-family: var(--font-body);
      font-size: 13px;
      font-weight: 500;
      padding: 10px 20px;
      border-radius: 5px;
      animation: toastIn 0.25s ease-out, toastOut 0.25s ease-in 2.5s forwards;
      max-width: 360px;
    }

    .toast-success { background: var(--green); color: #fff; }
    .toast-error { background: var(--red); color: #fff; }

    @keyframes toastIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes toastOut { from { opacity: 1; } to { opacity: 0; } }

    /* --- LOADING --- */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 17, 21, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .loading-overlay.hidden { display: none; }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* --- CONFIRM DIALOG --- */
    .confirm-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 17, 21, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1001;
    }

    .confirm-overlay.hidden { display: none; }

    .confirm-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
    }

    .confirm-box p {
      font-size: 14px;
      margin-bottom: 20px;
      color: var(--text);
      line-height: 1.6;
    }

    .confirm-actions { display: flex; justify-content: flex-end; gap: 8px; }

    /* --- RESPONSIVE --- */
    @media (max-width: 768px) {
      .main { grid-template-columns: 1fr; }
      .sidebar { border-right: none; border-bottom: 1px solid var(--border); max-height: 50vh; }
      .header { padding: 16px 20px; }
      .sidebar-header { padding: 16px 20px 12px; }
      .player-item { padding: 10px 20px; }
      .player-count { padding: 10px 20px; }
      .bye-info { padding: 10px 20px; }
      .panel-toolbar { padding: 12px 20px; flex-wrap: wrap; }
      .match-sections { padding: 12px 20px 24px; }
    }
  </style>
</head>
<body>

  <div class="loading-overlay hidden" id="loading"><div class="spinner"></div></div>

  <div class="confirm-overlay hidden" id="confirmOverlay">
    <div class="confirm-box">
      <p id="confirmMessage">Are you sure?</p>
      <div class="confirm-actions">
        <button class="btn btn-outline" id="confirmCancel">Cancel</button>
        <button class="btn btn-danger" id="confirmOk">Confirm</button>
      </div>
    </div>
  </div>

  <div class="toast-container" id="toasts"></div>

  <header class="header">
    <h1>POKER TOURNAMENT // ADMIN</h1>
    <div class="header-right">
      <span class="status-badge status-setup" id="statusBadge">SETUP</span>
    </div>
  </header>

  <div class="main">

    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>Players</h2>
        <div class="add-player-form" id="addPlayerForm">
          <div class="add-player-row">
            <input type="text" id="inputName" placeholder="Player name">
            <input type="text" id="inputTornId" placeholder="Torn ID">
          </div>
          <div class="form-buttons">
            <button class="btn-add" id="btnAddPlayer">Add Player</button>
            <button class="btn-sample" id="btnSample">Sample Data</button>
          </div>
        </div>
      </div>

      <div class="bye-info hidden" id="byeInfo">
        <span class="bye-needed" id="byeNeeded">0 byes needed</span>
        <span class="bye-count" id="byeCount">0 / 0 assigned</span>
      </div>

      <div class="player-list" id="playerList"></div>
      <div class="player-count" id="playerCount">0 players</div>
    </aside>

    <div class="panel">
      <div class="panel-toolbar">
        <h2>Matches</h2>
        <div class="toolbar-actions">
          <button class="btn btn-primary" id="btnGenerate">Generate Bracket</button>
          <button class="btn btn-danger" id="btnReset">Reset</button>
        </div>
      </div>
      <div class="match-sections" id="matchSections">
        <p style="color: var(--text-muted); padding: 24px 0; text-align: center; font-size: 14px;">
          Add players and generate a bracket to begin.
        </p>
      </div>
    </div>

  </div>

  <script>
    // PASTE YOUR APPS SCRIPT WEB APP URL BELOW
    var API_URL = 'YOUR_APPS_SCRIPT_URL_HERE';

    var state = { settings: {}, players: [], matches: [], byeInfo: {} };

    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('btnAddPlayer').addEventListener('click', addPlayer);
      document.getElementById('btnGenerate').addEventListener('click', generateBracket);
      document.getElementById('btnReset').addEventListener('click', resetTournament);
      document.getElementById('btnSample').addEventListener('click', loadSampleData);

      document.getElementById('inputName').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') document.getElementById('inputTornId').focus();
      });
      document.getElementById('inputTornId').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') addPlayer();
      });

      fetchState();
    });

    // --- API ---
    function apiCall(action, params, callback) {
      var url = API_URL + '?action=' + encodeURIComponent(action);
      if (params) {
        Object.keys(params).forEach(function(key) {
          url += '&' + encodeURIComponent(key) + '=' + encodeURIComponent(params[key]);
        });
      }

      showLoading(true);

      fetch(url)
        .then(function(res) { return res.json(); })
        .then(function(data) {
          showLoading(false);
          if (data.error) {
            toast(data.error, 'error');
          } else if (callback) {
            callback(data);
          }
        })
        .catch(function(err) {
          showLoading(false);
          toast('Request failed: ' + err.message, 'error');
        });
    }

    function fetchState() {
      apiCall('getState', null, function(data) {
        state = data;
        renderAll();
      });
    }

    // --- ACTIONS ---
    function addPlayer() {
      var name = document.getElementById('inputName').value.trim();
      var tornId = document.getElementById('inputTornId').value.trim();
      if (!name || !tornId) return toast('Name and Torn ID required', 'error');

      apiCall('addPlayer', { name: name, tornId: tornId }, function(data) {
        toast(data.message, 'success');
        document.getElementById('inputName').value = '';
        document.getElementById('inputTornId').value = '';
        document.getElementById('inputName').focus();
        fetchState();
      });
    }

    function removePlayer(tornId) {
      apiCall('removePlayer', { tornId: tornId }, function(data) {
        toast(data.message, 'success');
        fetchState();
      });
    }

    function toggleBye(tornId) {
      apiCall('toggleBye', { tornId: tornId }, function(data) {
        toast(data.message, 'success');
        fetchState();
      });
    }

    function loadSampleData() {
      showConfirm('Load 10 sample players? This will replace any existing players.', function() {
        apiCall('loadSampleData', null, function(data) {
          toast(data.message, 'success');
          fetchState();
        });
      });
    }

    function generateBracket() {
      var bi = state.byeInfo || {};
      if (bi.byesNeeded > 0 && bi.byesAssigned !== bi.byesNeeded) {
        toast('Mark exactly ' + bi.byesNeeded + ' player(s) with a bye before generating', 'error');
        return;
      }
      showConfirm('Generate bracket? Players will be randomly seeded. You cannot change the roster after this.', function() {
        apiCall('generateBracket', null, function(data) {
          toast(data.message, 'success');
          fetchState();
        });
      });
    }

    function resetTournament() {
      showConfirm('Reset the tournament? All match results will be cleared. Players will be kept, byes will be reset.', function() {
        apiCall('resetTournament', null, function(data) {
          toast(data.message, 'success');
          fetchState();
        });
      });
    }

    function recordResult(matchId, winnerSlot) {
      var match = state.matches.find(function(m) { return m.matchId === matchId; });
      if (!match) return;
      var winnerName = (winnerSlot === '1') ? match.player1Name : match.player2Name;

      showConfirm('Record ' + winnerName + ' as the winner of ' + matchId + '?', function() {
        apiCall('recordResult', { matchId: matchId, winnerSlot: winnerSlot }, function(data) {
          toast(data.winner + ' wins ' + matchId, 'success');
          fetchState();
        });
      });
    }

    // --- RENDER ---
    function renderAll() {
      renderStatus();
      renderPlayers();
      renderByeInfo();
      renderMatches();
    }

    function renderStatus() {
      var badge = document.getElementById('statusBadge');
      var status = (state.settings && state.settings.tournament_status) || 'setup';
      badge.textContent = status.toUpperCase();
      badge.className = 'status-badge status-' + status;

      var form = document.getElementById('addPlayerForm');
      var isSetup = (status === 'setup');
      form.style.display = isSetup ? 'flex' : 'none';

      var bi = state.byeInfo || {};
      var byesOk = bi.byesNeeded === 0 || bi.byesAssigned === bi.byesNeeded;
      document.getElementById('btnGenerate').disabled = !isSetup || !state.players || state.players.length < 2 || !byesOk;
    }

    function renderByeInfo() {
      var el = document.getElementById('byeInfo');
      var bi = state.byeInfo || {};
      var isSetup = (!state.settings.tournament_status || state.settings.tournament_status === 'setup');

      if (!isSetup || !state.players || state.players.length < 2 || bi.byesNeeded === 0) {
        el.classList.add('hidden');
        return;
      }

      el.classList.remove('hidden');

      document.getElementById('byeNeeded').textContent = bi.byesNeeded + ' bye' + (bi.byesNeeded !== 1 ? 's' : '') + ' needed (bracket size ' + bi.bracketSize + ')';

      var countEl = document.getElementById('byeCount');
      countEl.textContent = bi.byesAssigned + ' / ' + bi.byesNeeded + ' assigned';
      countEl.className = 'bye-count ' + (bi.byesAssigned === bi.byesNeeded ? 'ok' : 'mismatch');
    }

    function renderPlayers() {
      var list = document.getElementById('playerList');
      var count = document.getElementById('playerCount');
      var isSetup = (!state.settings.tournament_status || state.settings.tournament_status === 'setup');
      var bi = state.byeInfo || {};
      var showByeCheckbox = isSetup && bi.byesNeeded > 0;

      if (!state.players || state.players.length === 0) {
        list.innerHTML = '<p style="color: var(--text-muted); padding: 20px 24px; font-size: 13px;">No players yet.</p>';
        count.textContent = '0 players';
        return;
      }

      var html = '';
      state.players.forEach(function(p) {
        html += '<div class="player-item">';

        if (showByeCheckbox) {
          html += '<input type="checkbox" class="bye-toggle" ' + (p.bye ? 'checked' : '') + ' onclick="toggleBye(\'' + esc(p.tornId) + '\')" title="Toggle bye">';
        }

        html += '<div class="player-info">';
        html += '  <span class="player-name">' + esc(p.name) + '</span>';
        html += '  <div class="player-meta">';
        html += '    <span class="player-torn-id"><a href="https://www.torn.com/profiles.php?XID=' + esc(p.tornId) + '" target="_blank" rel="noopener">#' + esc(p.tornId) + '</a></span>';
        if (p.bye) {
          html += '    <span class="player-bye-label">BYE</span>';
        }
        html += '  </div>';
        html += '</div>';

        if (isSetup) {
          html += '<button class="btn-remove" onclick="removePlayer(\'' + esc(p.tornId) + '\')">x</button>';
        }

        html += '</div>';
      });

      list.innerHTML = html;
      count.textContent = state.players.length + ' player' + (state.players.length !== 1 ? 's' : '');
    }

    function renderMatches() {
      var container = document.getElementById('matchSections');

      if (!state.matches || state.matches.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted); padding: 24px 0; text-align: center; font-size: 14px;">Add players and generate a bracket to begin.</p>';
        return;
      }

      var html = '';

      if (state.settings.tournament_status === 'complete' && state.settings.champion) {
        html += '<div class="champion-banner">';
        html += '  <h3>Tournament Champion</h3>';
        html += '  <div class="champion-name">' + esc(state.settings.champion) + '</div>';
        html += '</div>';
      }

      var winners = state.matches.filter(function(m) { return m.bracket === 'winners'; });
      var losers = state.matches.filter(function(m) { return m.bracket === 'losers'; });
      var gf = state.matches.filter(function(m) { return m.bracket === 'grand_finals'; });

      var sortFn = function(a, b) {
        if (a.round !== b.round) return a.round - b.round;
        return a.match - b.match;
      };

      winners.sort(sortFn);
      losers.sort(sortFn);
      gf.sort(sortFn);

      if (winners.length > 0) html += renderMatchSection('Winners Bracket', winners);
      if (losers.length > 0) html += renderMatchSection('Losers Bracket', losers);
      if (gf.length > 0) html += renderMatchSection('Grand Finals', gf);

      container.innerHTML = html;
    }

    function renderMatchSection(title, matches) {
      var html = '<div class="section-title">' + title + '</div>';
      matches.forEach(function(m) { html += renderMatchCard(m); });
      return html;
    }

    function renderMatchCard(m) {
      var isReady = (m.status === 'ready');
      var isComplete = (m.status === 'complete');
      var p1IsWinner = isComplete && m.winnerName === m.player1Name;
      var p2IsWinner = isComplete && m.winnerName === m.player2Name;

      var html = '<div class="match-card">';
      html += '<div class="match-header">';
      html += '  <span class="match-id">' + esc(m.matchId) + '</span>';
      html += '  <span class="match-status match-status-' + m.status + '">' + m.status + '</span>';
      html += '</div>';
      html += '<div class="match-body">';
      html += renderMatchPlayer(m, '1', m.player1Name, m.player1TornID, isReady, p1IsWinner, isComplete && !p1IsWinner);
      html += '<span class="match-vs">vs</span>';
      html += renderMatchPlayer(m, '2', m.player2Name, m.player2TornID, isReady, p2IsWinner, isComplete && !p2IsWinner);
      html += '</div></div>';
      return html;
    }

    function renderMatchPlayer(match, slot, name, tornId, isReady, isWinner, isLoser) {
      var cls = 'match-player';
      if (isWinner) cls += ' winner-highlight';
      if (isLoser) cls += ' loser-highlight';

      var html = '<div class="' + cls + '">';
      if (!name) {
        html += '<span class="match-player-name tbd">TBD</span>';
      } else if (name === 'BYE') {
        html += '<span class="match-player-name bye">BYE</span>';
      } else {
        html += '<span class="match-player-name">' + esc(name) + '</span>';
      }

      if (isReady && name && name !== 'BYE') {
        html += '<button class="btn-win" onclick="recordResult(\'' + esc(match.matchId) + '\', \'' + slot + '\')">WIN</button>';
      }

      html += '</div>';
      return html;
    }

    // --- UI HELPERS ---
    function showLoading(show) {
      document.getElementById('loading').classList.toggle('hidden', !show);
    }

    function toast(message, type) {
      var container = document.getElementById('toasts');
      var el = document.createElement('div');
      el.className = 'toast toast-' + (type || 'success');
      el.textContent = message;
      container.appendChild(el);
      setTimeout(function() { el.remove(); }, 3000);
    }

    function showConfirm(message, onConfirm) {
      var overlay = document.getElementById('confirmOverlay');
      document.getElementById('confirmMessage').textContent = message;
      overlay.classList.remove('hidden');

      var okBtn = document.getElementById('confirmOk');
      var cancelBtn = document.getElementById('confirmCancel');

      function cleanup() {
        overlay.classList.add('hidden');
        okBtn.removeEventListener('click', handleOk);
        cancelBtn.removeEventListener('click', handleCancel);
      }

      function handleOk() { cleanup(); onConfirm(); }
      function handleCancel() { cleanup(); }

      okBtn.addEventListener('click', handleOk);
      cancelBtn.addEventListener('click', handleCancel);
    }

    function esc(str) {
      if (!str) return '';
      var div = document.createElement('div');
      div.textContent = String(str);
      return div.innerHTML;
    }
  </script>

</body>
</html>
